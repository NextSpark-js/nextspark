---
description: "[Theme] Initialize or update theme design system from CSS or mock"
---

# Initialize Design System

Initialize or update the active theme's design system. Supports two input paths:
1. **From CSS file:** Direct CSS export from tweakcn.com or similar
2. **From mock:** Extract design tokens from a design mock

**Input:**
{{{ input }}}

---

## Protocol Overview

```
Step 0: Parse Input
Step 1: Determine Active Theme
Step 2: Check Existing globals.css ‚Üí ASK USER
Step 3: Route to Appropriate Path
  Path 1: Process CSS File
  Path 2: Analyze Mock ‚Üí Generate CSS (INFORM about dark mode)
Step 4: Write globals.css
Step 5: Rebuild Theme
Step 6: Validate
```

---

## Step 0: Parse Input

Determine which path to take based on input:

**Path 1 Indicators:**
- Input ends with `.css`
- Input contains CSS content (starts with `:root` or contains `--background:`)
- Flag `--from-css` is present

**Path 2 Indicators:**
- Input is a folder path
- Flag `--from-mock` is present
- Folder contains `code.html` or `index.html`

```typescript
// Determine path
if (input.endsWith('.css') || input.includes('--from-css')) {
  route = 'PATH_1_CSS'
} else if (input.includes('--from-mock') || isMockFolder(input)) {
  route = 'PATH_2_MOCK'
} else {
  // Ask user
  await AskUserQuestion({
    questions: [{
      header: "Input Type",
      question: "What type of input are you providing?",
      options: [
        { label: "CSS File", description: "Export from tweakcn.com or similar" },
        { label: "Mock Folder", description: "Design mock with HTML/images" }
      ],
      multiSelect: false
    }]
  })
}
```

---

## Step 1: Determine Active Theme

```bash
# Read active theme from environment
grep "NEXT_PUBLIC_ACTIVE_THEME" .env .env.local 2>/dev/null | head -1 | cut -d'=' -f2
```

Default to "default" if not found.

**Target file:** `themes/{THEME}/styles/globals.css`

---

## Step 2: Check Existing globals.css (MANDATORY)

**ALWAYS check if globals.css exists and ASK the user:**

```bash
# Check if file exists
if [ -f "themes/{THEME}/styles/globals.css" ]; then
  echo "File exists"
fi
```

**If file exists, use AskUserQuestion:**

```typescript
await AskUserQuestion({
  questions: [{
    header: "Overwrite",
    question: `globals.css already exists in theme "${THEME}". What would you like to do?`,
    options: [
      { label: "Overwrite", description: "Replace existing file (backup will be created as .bak)" },
      { label: "View Diff", description: "Show differences before deciding" },
      { label: "Cancel", description: "Abort operation" }
    ],
    multiSelect: false
  }]
})
```

**Handle responses:**
- **Overwrite:** Create backup, continue with write
- **View Diff:** Show comparison, then ask again
- **Cancel:** Exit gracefully

**Confirm with user before proceeding:**
```markdown
## Design System Initialization

**Active Theme:** {THEME}
**Target File:** themes/{THEME}/styles/globals.css
**Input Path:** {route}
**Existing file:** {exists ? "Will be backed up" : "New file"}

Proceed?
```

---

## Path 1: Process CSS File

### Step 1.1: Read CSS Content

```bash
# If file path provided
cat {cssFilePath}

# If content provided directly, use as-is
```

### Step 1.2: Validate CSS Structure

Check for required variables:

```javascript
const REQUIRED_VARIABLES = [
  '--background', '--foreground',
  '--primary', '--primary-foreground',
  '--secondary', '--secondary-foreground',
  '--muted', '--muted-foreground',
  '--accent', '--accent-foreground',
  '--destructive', '--destructive-foreground',
  '--border', '--input', '--ring',
  '--card', '--card-foreground',
  '--popover', '--popover-foreground',
  '--radius'
]

// Validate all required vars exist
for (const varName of REQUIRED_VARIABLES) {
  if (!css.includes(`${varName}:`)) {
    missingVars.push(varName)
  }
}
```

**If missing variables:**
```markdown
‚ö†Ô∏è Missing required CSS variables:
{missingVars.join('\n')}

Options:
1. Add missing variables with default values (auto-complete)
2. Cancel and fix the CSS file
```

### Step 1.3: Check for @theme inline Section

If missing, add the complete Tailwind v4 mapping (use template below).

### Step 1.4: Format and Prepare Final CSS

```javascript
const finalCSS = `/**
 * Theme: ${theme}
 * Generated by: theme:design-system command
 * Source: ${source}
 * Date: ${new Date().toISOString()}
 */

${lightModeSection}

${darkModeSection}

${themeInlineSection}
`
```

---

## Path 2: Analyze Mock ‚Üí Generate CSS

### Step 2.1: Launch ds-analyst Agent (GENERATE mode)

```
Launch Task: ds-analyst agent

**Mode:** GENERATE
**Mock Path:** {mockPath}
**Theme:** {THEME}
**Output Path:** {mockPath}

Analyze the mock and generate globals.css with complete token analysis.
Convert colors to OKLCH and generate dark mode by inverting lightness.
```

Wait for agent completion.

### Step 2.2: INFORM User About Dark Mode

**MANDATORY: After generating, show this message:**

```markdown
‚ÑπÔ∏è **Dark mode generado autom√°ticamente**

El mock no inclu√≠a dark mode expl√≠cito. Se gener√≥ autom√°ticamente
invirtiendo los valores de lightness (L) en OKLCH.

**Ejemplo de inversi√≥n:**
- Light: `oklch(0.95 0.02 250)` ‚Üí Dark: `oklch(0.05 0.02 250)`
- Light: `oklch(0.15 0 0)` ‚Üí Dark: `oklch(0.85 0 0)`

Revisa `themes/{THEME}/styles/globals.css` y ajusta los valores
de `.dark {}` si es necesario para tu marca.
```

---

## Step 4: Write globals.css

### Step 4.1: Create Backup (if exists)

```bash
if [ -f "themes/{THEME}/styles/globals.css" ]; then
  cp "themes/{THEME}/styles/globals.css" "themes/{THEME}/styles/globals.css.bak"
  echo "‚úÖ Backup created: globals.css.bak"
fi
```

### Step 4.2: Write New File

Write the generated CSS to `themes/{THEME}/styles/globals.css`.

### Step 4.3: Confirm Write

```markdown
## ‚úÖ Written: themes/{THEME}/styles/globals.css

**Variables defined:**
- Light mode: {n} variables
- Dark mode: {n} overrides
- @theme inline: Complete

**Backup:** themes/{THEME}/styles/globals.css.bak (if existed)
```

---

## Step 5: Rebuild Theme

```bash
pnpm theme:build
```

**Expected output:**
```
üé® Building theme system...
üìã Active theme: {THEME}
   ‚úÖ Loaded globals.css ({n} chars)
‚úÖ Theme built successfully!
```

If build fails, report error and suggest fixes.

---

## Step 6: Validate

### Step 6.1: Check Generated File

```bash
ls -la core/theme-styles.css
head -50 core/theme-styles.css
```

### Step 6.2: Final Summary

```markdown
## ‚úÖ Design System Initialized

**Theme:** {THEME}
**Source:** {CSS file | Mock: path}
**Dark mode:** {From source | Auto-generated (review recommended)}

**Files updated:**
- themes/{THEME}/styles/globals.css
- core/theme-styles.css

**Next steps:**
1. Start dev server: `pnpm dev`
2. Check light mode appearance
3. Toggle to dark mode
4. Adjust `.dark {}` values if needed
5. Commit when satisfied

**Rollback if needed:**
```bash
cp themes/{THEME}/styles/globals.css.bak themes/{THEME}/styles/globals.css
pnpm theme:build
```
```

---

## Template: @theme inline Section

When adding missing `@theme inline`, use this complete template:

```css
@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-card: var(--card);
  --color-card-foreground: var(--card-foreground);
  --color-popover: var(--popover);
  --color-popover-foreground: var(--popover-foreground);
  --color-primary: var(--primary);
  --color-primary-foreground: var(--primary-foreground);
  --color-secondary: var(--secondary);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-muted: var(--muted);
  --color-muted-foreground: var(--muted-foreground);
  --color-accent: var(--accent);
  --color-accent-foreground: var(--accent-foreground);
  --color-destructive: var(--destructive);
  --color-destructive-foreground: var(--destructive-foreground);
  --color-border: var(--border);
  --color-input: var(--input);
  --color-ring: var(--ring);
  --color-chart-1: var(--chart-1);
  --color-chart-2: var(--chart-2);
  --color-chart-3: var(--chart-3);
  --color-chart-4: var(--chart-4);
  --color-chart-5: var(--chart-5);
  --color-sidebar: var(--sidebar);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-ring: var(--sidebar-ring);

  --font-sans: var(--font-sans);
  --font-mono: var(--font-mono);
  --font-serif: var(--font-serif);

  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);

  --shadow-2xs: var(--shadow-2xs);
  --shadow-xs: var(--shadow-xs);
  --shadow-sm: var(--shadow-sm);
  --shadow: var(--shadow);
  --shadow-md: var(--shadow-md);
  --shadow-lg: var(--shadow-lg);
  --shadow-xl: var(--shadow-xl);
  --shadow-2xl: var(--shadow-2xl);
}
```

---

## Usage Examples

```bash
# Path 1: From tweakcn.com CSS file
/theme-design-system _tmp/my-theme.css

# Path 1: From CSS content (paste)
/theme-design-system --from-css
# (Then paste CSS content)

# Path 2: From mock folder
/theme-design-system --from-mock _tmp/mocks/stitch/landing-page

# Path 2: Shorthand (folder auto-detection)
/theme-design-system _tmp/mocks/stitch/landing-page
```

---

## Related Commands

- `/mock-analyze` - Standalone design token analysis
- `/mock-to-blocks` - Full mock-to-blocks workflow
- `/block-create` - Create new page builder blocks

---

## Required Skills

Before executing this command, read:
- `shadcn-theming` - CSS variable reference and tweakcn.com integration
- `tailwind-theming` - Tailwind v4 patterns
- `design-system` - Token mapping patterns (for Path 2)

---

**Now process the input specified above.**
