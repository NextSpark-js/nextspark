---
name: entity-system
description: |
  Config-driven entity system for creating automatic CRUDs.
  Includes: config, fields, types, service, messages (i18n), migrations.
  Use this skill to create, modify, or understand system entities.
allowed-tools: Read, Glob, Grep, Bash(python:*)
version: 1.0.0
---

# Entity System Skill

Config-driven system for defining entities with automatic CRUDs, similar to WordPress Custom Post Types.

## Architecture Overview

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          ENTITY CONFIGURATION                            │
│                                                                          │
│  contents/themes/{theme}/entities/{entity}/                              │
│  ├── {entity}.config.ts    ← Main configuration                          │
│  ├── {entity}.fields.ts    ← Field definitions                           │
│  ├── {entity}.types.ts     ← TypeScript types                            │
│  ├── {entity}.service.ts   ← Optional but recommended                    │
│  ├── messages/                                                           │
│  │   ├── en.json           ← English translations                        │
│  │   ├── es.json           ← Spanish translations                        │
│  │   └── {locale}.json     ← Additional locales if project requires      │
│  └── migrations/                                                         │
│      ├── 001_{entity}_table.sql                                          │
│      ├── 002_{entity}_metas.sql (if metadata enabled)                    │
│      └── sample_data.json  ← Sample data for seeding                     │
└──────────────────────────────────────────────────────────────────────────┘
```

## When to Use This Skill

- Creating a new entity (CRUD resource)
- Adding/modifying fields on an entity
- Understanding entity configuration structure
- Generating migrations for entity tables
- Creating sample data for development

## Entity Configuration Structure

### EntityConfig (4 Sections)

```typescript
interface EntityConfig {
  // 1. BASIC IDENTIFICATION
  slug: string           // URL/table name (single source of truth)
  enabled: boolean
  names: { singular: string, plural: string }
  icon: LucideIcon

  // 2. ACCESS AND SCOPE
  access: {
    public: boolean      // Accessible without auth
    api: boolean         // Has external API endpoints
    metadata: boolean    // Supports key-value metadata
    shared: boolean      // Shared among team members (no userId filter)
  }

  // 3. UI/UX FEATURES
  ui: {
    dashboard: {
      showInMenu: boolean
      showInTopbar: boolean
      filters?: EntityFilterConfig[]
    }
    public: {
      hasArchivePage: boolean
      hasSinglePage: boolean
    }
    features: {
      searchable: boolean
      sortable: boolean
      filterable: boolean
      bulkOperations: boolean
      importExport: boolean
    }
  }

  // 4. INTERNATIONALIZATION
  i18n: {
    fallbackLocale: 'en' | 'es'
    loaders: Record<'en' | 'es', () => Promise<object>>
  }

  // FIELDS (imported separately)
  fields: EntityField[]
}
```

> **Note:** Permissions are defined centrally in `config/permissions.config.ts`, not in entity config.

### Field Types

```typescript
type EntityFieldType =
  // Basic
  | 'text' | 'textarea' | 'number' | 'boolean' | 'date' | 'datetime'
  | 'email' | 'url' | 'json'

  // Selection
  | 'select' | 'multiselect' | 'radio' | 'buttongroup' | 'tags' | 'combobox'

  // Media
  | 'file' | 'image' | 'video' | 'audio'

  // Specialized
  | 'phone' | 'rating' | 'range' | 'doublerange'
  | 'markdown' | 'richtext' | 'code'
  | 'timezone' | 'currency' | 'country' | 'address'

  // Relations
  | 'relation' | 'relation-multi' | 'relation-prop' | 'relation-prop-multi'
  | 'reference' | 'user'
```

### Field Definition

```typescript
interface EntityField {
  name: string
  type: EntityFieldType
  required: boolean
  defaultValue?: unknown
  validation?: ZodSchema

  display: {
    label: string
    description?: string
    placeholder?: string
    showInList: boolean
    showInDetail: boolean
    showInForm: boolean
    order: number
    columnWidth?: number  // 1-12 grid
  }

  api: {
    searchable: boolean
    sortable: boolean
    filterable?: boolean
    readOnly: boolean
  }

  // For select/multiselect
  options?: { value: string, label: string }[]

  // For relations
  relation?: {
    entity: string
    titleField?: string
    parentId?: string
    userFiltered?: boolean
  }
}
```

## Auto-Generated Features

From an EntityConfig, the system automatically provides:

1. **Database Table** - Via migrations
2. **API Endpoints** - `/api/v1/{slug}` with CRUD operations
3. **Dashboard UI** - List, create, edit, delete views
4. **Form Components** - Auto-generated from fields
5. **Validation** - Server and client-side from field config
6. **i18n Support** - Labels, placeholders, messages
7. **Search & Filtering** - Based on field API config
8. **Metadata System** - Key-value pairs (if enabled)

## Metadata System

When `access.metadata: true` is set in the entity config, the entity supports dynamic key-value metadata.

### Migration Required

A separate migration creates the `{entity}_metas` table:

```sql
-- migrations/002_{entity}_metas.sql
CREATE TABLE IF NOT EXISTS "{entity}_metas" (
  "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
  "{entity}Id" TEXT NOT NULL REFERENCES "{entity}"(id) ON DELETE CASCADE,
  "metaKey" TEXT NOT NULL,
  "metaValue" JSONB NOT NULL DEFAULT '{}'::jsonb,
  "dataType" TEXT,                              -- Optional: string, number, boolean, json
  "isPublic" BOOLEAN NOT NULL DEFAULT FALSE,    -- Visible without auth
  "isSearchable" BOOLEAN NOT NULL DEFAULT FALSE, -- Indexed for search
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT now(),
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT {entity}_metas_unique_key UNIQUE ("{entity}Id", "metaKey")
);

-- Indexes
CREATE INDEX "idx_{entity}_metas_entity_id" ON "{entity}_metas"("{entity}Id");
CREATE INDEX "idx_{entity}_metas_key" ON "{entity}_metas"("metaKey");
CREATE INDEX "idx_{entity}_metas_value_gin" ON "{entity}_metas" USING GIN ("metaValue");
```

### When to Use Metas vs Fields

| Use Case | Fields | Metas |
|----------|--------|-------|
| Structured, validated data | ✅ | ❌ |
| Shown in forms/lists | ✅ | ❌ |
| Searchable/sortable | ✅ | ❌ |
| Dynamic/extensible data | ❌ | ✅ |
| Plugin-specific data | ❌ | ✅ |
| User preferences/settings | ❌ | ✅ |
| Third-party integrations | ❌ | ✅ |

### API Access

Metas are accessed via query parameter (covered in `entity-api` skill):
```
GET /api/v1/products/123?metas=all
GET /api/v1/products/123?metas=category,tags
```

## Child Entities

Child entities are 1:N relationships where the child only exists in the context of its parent (e.g., order items, post comments).

### Configuration in EntityConfig

```typescript
export const orderEntityConfig: EntityConfig = {
  slug: 'orders',
  // ... other config

  childEntities: {
    'items': {
      table: 'order_items',           // Convention: {parent}_{child}
      showInParentView: true,         // Show in parent detail view
      hasOwnRoutes: false,            // Only via /orders/{id}/child/items

      fields: [
        {
          name: 'productName',
          type: 'text',
          required: true,
          display: { label: 'Product' }
        },
        {
          name: 'quantity',
          type: 'number',
          required: true,
          display: { label: 'Qty' }
        }
      ],

      display: {
        title: 'Order Items',
        description: 'Products in this order',
        mode: 'table'                 // 'table' | 'cards' | 'list'
      }
    }
  }
}
```

### ChildEntityDefinition Interface

```typescript
interface ChildEntityDefinition {
  table: string                    // Database table name
  fields: ChildEntityField[]       // Child entity fields
  showInParentView: boolean        // Show in parent view
  hasOwnRoutes: boolean            // Has independent routes?
  permissions?: EntityPermissions  // Specific permissions (inherits from parent if not set)
  display: {
    title: string
    description?: string
    mode: 'table' | 'cards' | 'list'
  }
}
```

### Migration Required

```sql
-- migrations/002_{parent}_{child}.sql
CREATE TABLE "order_items" (
  "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
  "parentId" TEXT NOT NULL REFERENCES "orders"(id) ON DELETE CASCADE,
  "productName" VARCHAR(255) NOT NULL,
  "quantity" INTEGER NOT NULL,
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT now(),
  "updatedAt" TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX "idx_order_items_parentId" ON "order_items"("parentId");

-- RLS: Access via parent ownership
ALTER TABLE "order_items" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "order_items_via_parent" ON "order_items"
  FOR ALL TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM "orders"
      WHERE "orders".id = "parentId"
      AND "orders"."userId" = public.get_auth_user_id()
    )
  );
```

### Key Properties

| Property | Required | Description |
|----------|----------|-------------|
| `table` | Yes | Table name. Convention: `{parent}_{child}` |
| `fields` | Yes | Child entity fields (same structure as entity fields) |
| `showInParentView` | Yes | Display in parent detail view |
| `hasOwnRoutes` | Yes | If `true`: also `/api/v1/{child}`. If `false`: only via parent |
| `display.mode` | Yes | `table` (rows), `cards` (cards), `list` (simple) |

### Limitations

- **One level deep**: Child entities cannot have their own children
- **Cascade deletion**: Deleting parent deletes all children
- **No public routes**: Children don't have public pages

### API Access

Child entity endpoints (covered in `entity-api` skill):
```
GET    /api/v1/orders/{id}/child/items
POST   /api/v1/orders/{id}/child/items
GET    /api/v1/orders/{id}/child/items/{itemId}
PATCH  /api/v1/orders/{id}/child/items/{itemId}
DELETE /api/v1/orders/{id}/child/items/{itemId}
```

## Scripts

### Scaffold New Entity
```bash
python .claude/skills/entity-system/scripts/scaffold-entity.py --entity products --theme default
```

### Generate Migration
```bash
python .claude/skills/entity-system/scripts/generate-migration.py --entity products --theme default
```

### Generate Metas Migration
```bash
python .claude/skills/entity-system/scripts/generate-metas-migration.py --entity products --theme default
```

### Generate Child Entity Migration
```bash
python .claude/skills/entity-system/scripts/generate-child-migration.py --parent orders --child items --theme default
```

### Generate Sample Data
```bash
python .claude/skills/entity-system/scripts/generate-sample-data.py --entity products --count 10
```

## Key Files Reference

| File | Purpose |
|------|---------|
| `core/lib/entities/types.ts` | All entity type definitions |
| `core/lib/entities/migration-helper.ts` | Migration SQL generation |
| `core/lib/entities/registry.ts` | Entity registry (auto-generated) |
| `core/lib/entities/queries.ts` | Database query helpers |
| `core/lib/entities/helpers.ts` | Utility functions |

## Naming Conventions

- **Slug**: kebab-case, plural (`tasks`, `blog-posts`)
- **Table**: Same as slug (`tasks`, `blog_posts`)
- **API Path**: `/api/v1/{slug}`
- **Config file**: `{singular}.config.ts` (`task.config.ts`)
- **Fields file**: `{slug}.fields.ts` (`tasks.fields.ts`)

## Anti-Patterns

```typescript
// ❌ NEVER: Add system fields manually
fields: [
  { name: 'id', type: 'text', ... },      // Auto-included
  { name: 'teamId', type: 'text', ... },  // Auto-included (team-mode entities)
  { name: 'createdAt', type: 'datetime' }, // Auto-included
  { name: 'updatedAt', type: 'datetime' }, // Auto-included
]

// ❌ NEVER: Use dynamic imports for entity configs
const config = await import(`@/contents/entities/${slug}`)

// ❌ NEVER: Define tableName explicitly (derived from slug)
tableName: 'my_custom_table'

// ✅ CORRECT: Only declare business fields
fields: [
  { name: 'title', type: 'text', ... },
  { name: 'status', type: 'select', ... },
]
```

## Checklist for New Entity

- [ ] Created `{entity}.config.ts` with all 5 sections
- [ ] Created `{entity}.fields.ts` with field definitions
- [ ] Created `{entity}.types.ts` with TypeScript interfaces
- [ ] Created `messages/` with required locales (en.json, es.json, + others if project defines)
- [ ] Created migration in `migrations/001_{entity}_table.sql`
- [ ] Created `_metas` migration if `access.metadata: true`
- [ ] Added entity to theme's entity registry
- [ ] Ran `node core/scripts/build/registry.mjs`

## References

- Load `references/entity-types.md` for complete type definitions
- Load `references/field-examples.md` for field configuration examples
- Load `references/migration-patterns.md` for SQL patterns
