/**
 * Scope Registry Generator
 *
 * Generates scope-registry.ts
 *
 * @module core/scripts/build/registry/generators/scope-registry
 */

/**
 * Generate the scope registry file
 *
 * @param {Array} entities - Discovered entities
 * @param {object} config - Configuration object from getConfig()
 * @returns {string} Generated TypeScript content
 */
export function generateScopeRegistry(entities, config) {
  // Generate base scopes from entities
  const baseScopes = []
  const entityPaths = []

  for (const entity of entities) {
    if (entity.api && entity.features?.enabled) {
      const entityName = entity.name
      baseScopes.push(`${entityName}:read`)

      // Add write scope if entity supports creation
      if (entity.api.endpoints && entity.api.endpoints.create) {
        baseScopes.push(`${entityName}:write`)
      }

      // Add delete scope for entities that support deletion
      if (entity.api.endpoints && entity.api.endpoints.delete) {
        baseScopes.push(`${entityName}:delete`)
      }

      // Collect entity paths for routing
      if (entity.api.apiPath) {
        entityPaths.push(entity.api.apiPath)
      }
    }
  }

  // Define role-based scopes
  const roleScopes = {
    'superadmin': ['admin:users', 'tasks:delete', 'products:write', 'products:delete', ...baseScopes.filter(s => s.includes(':delete'))],
    'admin': ['admin:users', 'tasks:delete', 'products:write', 'products:delete', ...baseScopes.filter(s => s.includes(':delete'))],
    'manager': baseScopes.filter(s => s.includes(':write') || s.includes(':read')),
    'member': baseScopes.filter(s => s.includes(':read') || s === 'tasks:write')
  }

  // Define flag-based scopes
  const flagScopes = {
    'beta_tester': ['beta:features'],
    'vip': ['vip:features', 'advanced:export'],
    'early_adopter': ['early:features'],
    'power_user': ['advanced:features', 'bulk:operations']
  }

  // Define allowed filters based on entities
  const allowedFilters = ['status', 'role', 'completed', 'userId']

  // Add entity-specific filters
  for (const entity of entities) {
    if (entity.api && entity.features?.enabled) {
      allowedFilters.push(`${entity.name}Id`)

      // Add common entity filters
      if (entity.fields) {
        const fields = Object.keys(entity.fields)
        if (fields.includes('status')) allowedFilters.push(`${entity.name}Status`)
        if (fields.includes('type')) allowedFilters.push(`${entity.name}Type`)
        if (fields.includes('category')) allowedFilters.push(`${entity.name}Category`)
      }
    }
  }

  const scopeConfig = {
    base: [...new Set(baseScopes)],
    roles: roleScopes,
    flags: flagScopes,
    restrictions: {
      'restricted': {
        remove: ['delete', 'admin']
      },
      'limited_access': {
        allow_only: ['read', 'tasks:write']
      }
    }
  }

  const apiConfig = {
    filters: {
      allowed: [...new Set(allowedFilters)]
    },
    entityPaths: [...new Set(entityPaths)]
  }

  return `/**
 * Auto-generated API Scope Registry
 *
 * Generated at: ${new Date().toISOString()}
 * Base scopes: ${scopeConfig.base.length}
 * Role configurations: ${Object.keys(scopeConfig.roles).length}
 * Flag configurations: ${Object.keys(scopeConfig.flags).length}
 * Allowed filters: ${apiConfig.filters.allowed.length}
 *
 * This file replaces hardcoded scope configurations in helpers.ts
 *
 * DO NOT EDIT - This file is auto-generated by scripts/build-registry.mjs
 */

export interface ScopeConfig {
  base: string[]
  roles: Record<string, string[]>
  flags: Record<string, string[]>
  restrictions: Record<string, { remove?: string[], allow_only?: string[] }>
}

export interface ApiConfig {
  filters: {
    allowed: string[]
  }
  entityPaths: string[]
}

export const SCOPE_CONFIG: ScopeConfig = ${JSON.stringify(scopeConfig, null, 2)}

export const API_CONFIG: ApiConfig = ${JSON.stringify(apiConfig, null, 2)}

// ==================== Service Layer ====================
// Query functions have been moved to: @nextsparkjs/core/lib/services/scope.service
// Import from there instead:
//
// import { ScopeService } from '@nextsparkjs/core/lib/services/scope.service'
//
// Available methods:
// - ScopeService.getBaseScopes() - Get base scopes
// - ScopeService.getRoleScopes(role) - Get role scopes
// - ScopeService.getFlagScopes(flag) - Get flag scopes
// - ScopeService.getAllowedFilters() - Get allowed filters
// - ScopeService.getRestrictionRules(flag) - Get restriction rules
// - ScopeService.getEntityApiPaths() - Get entity API paths
// - ScopeService.getRoles() - Get all role names
// - ScopeService.getFlags() - Get all flag names
// - ScopeService.hasRole(role) - Check if role exists
// - ScopeService.hasFlag(flag) - Check if flag exists
// - ScopeService.getScopeConfig() - Get full scope config
// - ScopeService.getApiConfig() - Get full API config
`
}
