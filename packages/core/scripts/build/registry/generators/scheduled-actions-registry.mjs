/**
 * Scheduled Actions Registry Generator
 *
 * Generates scheduled-actions-registry.ts (server-only)
 *
 * This generator creates a server-only registry for scheduled action initializers.
 * It's separate from theme-registry because scheduled actions contain server-only
 * code that cannot be imported by client components.
 *
 * @module core/scripts/build/registry/generators/scheduled-actions-registry
 */

/**
 * Generate the scheduled actions registry file
 * @param {Array} themes - Discovered themes with hasScheduledActions property
 * @param {object} config - Configuration object from getConfig()
 * @returns {string} Generated TypeScript content
 */
export function generateScheduledActionsRegistry(themes, config) {
  // Filter themes that have scheduled actions
  const themesWithScheduledActions = themes.filter(t => t.hasScheduledActions && t.scheduledActionsPath)

  // Generate imports for each theme with scheduled actions
  const imports = themesWithScheduledActions.map(theme => {
    const safeThemeName = theme.name.replace(/-/g, '_')
    return `import * as ${safeThemeName}ScheduledActions from '${theme.scheduledActionsPath}'`
  }).join('\n')

  // Generate the registry entries
  const registryEntries = themesWithScheduledActions.map(theme => {
    const safeThemeName = theme.name.replace(/-/g, '_')
    return `  '${theme.name}': {
    registerAllHandlers: ${safeThemeName}ScheduledActions.registerAllHandlers,
    registerRecurringActions: ${safeThemeName}ScheduledActions.registerRecurringActions,
  }`
  }).join(',\n')

  // Generate theme names for metadata
  const themeNames = themesWithScheduledActions.map(t => `'${t.name}'`).join(', ')

  return `/**
 * Auto-generated Scheduled Actions Registry (Server-Only)
 *
 * Generated at: ${new Date().toISOString()}
 * Themes with scheduled actions: ${themesWithScheduledActions.length}
 *
 * This registry provides access to theme-specific scheduled action initializers.
 * It is kept separate from theme-registry.ts because scheduled actions contain
 * server-only code (database access, etc.) that cannot be imported by client components.
 *
 * DO NOT EDIT - This file is auto-generated by scripts/build-registry.mjs
 */

import 'server-only'

${imports ? imports + '\n' : ''}
/**
 * Type for scheduled actions module
 */
export interface ScheduledActionsModule {
  registerAllHandlers: () => void
  registerRecurringActions: () => Promise<void>
}

/**
 * Registry of theme scheduled action modules
 * Auto-generated based on discovered themes with hasScheduledActions: true
 */
export const SCHEDULED_ACTIONS_REGISTRY: Record<string, ScheduledActionsModule> = {
${registryEntries}
}

/**
 * Registry metadata
 */
export const SCHEDULED_ACTIONS_METADATA = {
  totalThemes: ${themesWithScheduledActions.length},
  themes: [${themeNames}],
  generatedAt: '${new Date().toISOString()}'
}
`
}
