/**
 * Theme Registry Generator
 *
 * Generates theme-registry.ts
 *
 * @module core/scripts/build/registry/generators/theme-registry
 */

import { join } from 'path'
import { convertCorePath } from '../config.mjs'

/**
 * Generate the theme registry file
 * @param {Array} themes - Discovered themes
 * @param {object} config - Configuration object from getConfig()
 * @returns {string} Generated TypeScript content
 */
export function generateThemeRegistry(themes, config) {
  const outputFilePath = join(config.outputDir, 'theme-registry.ts')
  // Generate theme config imports
  const themeImports = themes.map(theme =>
    theme.exportName
      ? `import { ${theme.exportName} } from '${theme.configPath}'`
      : `import { ${theme.name}ThemeConfig } from '${theme.configPath}'`
  ).join('\n')

  // Generate dashboard config imports
  const dashboardImports = themes
    .filter(theme => theme.hasDashboardConfig)
    .map(theme => {
      // Convert theme name to valid JavaScript identifier
      const safeThemeName = theme.name.replace(/-/g, '_')
      return `import { ${theme.dashboardConfigExportName || 'DASHBOARD_CONFIG'} as ${safeThemeName}DashboardConfig } from '${theme.dashboardConfigPath}'`
    }).join('\n')

  // Generate app config imports
  const appImports = themes
    .filter(theme => theme.hasAppConfig)
    .map(theme => {
      // Convert theme name to valid JavaScript identifier
      const safeThemeName = theme.name.replace(/-/g, '_')
      return `import { ${theme.appConfigExportName || 'APP_CONFIG_OVERRIDES'} as ${safeThemeName}AppConfig } from '${theme.appConfigPath}'`
    }).join('\n')

  // Generate dev config imports (development-only settings)
  const devImports = themes
    .filter(theme => theme.hasDevConfig)
    .map(theme => {
      // Convert theme name to valid JavaScript identifier
      const safeThemeName = theme.name.replace(/-/g, '_')
      return `import { ${theme.devConfigExportName || 'DEV_CONFIG_OVERRIDES'} as ${safeThemeName}DevConfig } from '${theme.devConfigPath}'`
    }).join('\n')

  // Note: Scheduled actions are NOT imported here because they contain server-only code.
  // The theme registry is used by client components, so we only store the path.
  // Use the scheduledActionsPath to dynamically import where needed (server-side only).

  const imports = [themeImports, dashboardImports, appImports, devImports].filter(Boolean).join('\n')

  const registryEntries = themes.map(theme => {
    const configName = theme.exportName || `${theme.name}ThemeConfig`
    const safeThemeName = theme.name.replace(/-/g, '_')
    const dashboardConfigName = theme.hasDashboardConfig ? `${safeThemeName}DashboardConfig` : 'null'
    const appConfigName = theme.hasAppConfig ? `${safeThemeName}AppConfig` : 'null'
    const devConfigName = theme.hasDevConfig ? `${safeThemeName}DevConfig` : 'null'

    return `  '${theme.name}': {
    name: '${theme.name}',
    config: ${configName},
    hasComponents: ${theme.hasComponents},
    hasStyles: ${theme.hasStyles},
    hasAssets: ${theme.hasAssets || false},
    hasMessages: ${theme.hasMessages || false},
    hasDashboardConfig: ${theme.hasDashboardConfig || false},
    dashboardConfig: ${dashboardConfigName},
    hasAppConfig: ${theme.hasAppConfig || false},
    appConfig: ${appConfigName},
    hasDevConfig: ${theme.hasDevConfig || false},
    devConfig: ${devConfigName},
    hasScheduledActions: ${theme.hasScheduledActions || false},
    scheduledActionsPath: ${theme.scheduledActionsPath ? `'${theme.scheduledActionsPath}'` : 'null'},
    componentsPath: ${theme.componentsPath ? `'${theme.componentsPath}'` : 'null'},
    stylesPath: ${theme.stylesPath ? `'${theme.stylesPath}'` : 'null'},
    assetsPath: ${theme.assetsPath ? `'${theme.assetsPath}'` : 'null'},
    messagesPath: ${theme.messagesPath ? `'${theme.messagesPath}'` : 'null'},
    entities: ${JSON.stringify(theme.entities || [], null, 6).replace(/^/gm, '    ')},
    routeFiles: ${JSON.stringify(theme.routeFiles || [], null, 6).replace(/^/gm, '    ')},
    plugins: [${(theme.plugins || []).map(p => `'${p}'`).join(', ')}]
  }`
  }).join(',\n')

  return `/**
 * Auto-generated Theme Registry
 *
 * Generated at: ${new Date().toISOString()}
 * Themes discovered: ${themes.length}
 *
 * DO NOT EDIT - This file is auto-generated by scripts/build-registry.mjs
 */

${imports}
import type { ThemeConfig } from '${convertCorePath('@/core/types/theme', outputFilePath, config)}'
import type { DevConfig } from '${convertCorePath('@/core/lib/config/types', outputFilePath, config)}'

export interface ThemeEntity {
  name: string
  exportName: string
  configPath: string
  actualConfigFile: string
  relativePath: string
  depth: number
  parent: string | null
  children: string[]
  hasComponents: boolean
  hasHooks: boolean
  hasMigrations: boolean
  hasMessages: boolean
  hasAssets: boolean
  messagesPath: string
  pluginContext: { pluginName: string } | null
  themeContext: { themeName: string } | null
  source: string
}

export interface ThemeRouteFile {
  path: string
  filePath: string
  relativePath: string
  methods: string[]
  isRouteFile: boolean
  theme: string
}

export interface ThemeRegistryEntry {
  name: string
  config: ThemeConfig
  hasComponents: boolean
  hasStyles: boolean
  hasAssets: boolean
  hasMessages: boolean
  hasDashboardConfig: boolean
  dashboardConfig: any | null
  hasAppConfig: boolean
  appConfig: any | null
  hasDevConfig: boolean
  devConfig: DevConfig | null
  hasScheduledActions: boolean
  scheduledActionsPath: string | null
  componentsPath: string | null
  stylesPath: string | null
  assetsPath: string | null
  messagesPath: string | null
  entities: ThemeEntity[]
  routeFiles: ThemeRouteFile[]
  plugins: string[]
}

export const THEME_REGISTRY: Record<string, ThemeRegistryEntry> = {
${registryEntries}
}

export type ThemeName = keyof typeof THEME_REGISTRY

/**
 * Theme registry metadata
 */
export const THEME_METADATA = {
  totalThemes: ${themes.length},
  themesWithComponents: ${themes.filter(t => t.hasComponents).length},
  themesWithStyles: ${themes.filter(t => t.hasStyles).length},
  themesWithAssets: ${themes.filter(t => t.hasAssets).length},
  themesWithMessages: ${themes.filter(t => t.hasMessages).length},
  themesWithDashboardConfig: ${themes.filter(t => t.hasDashboardConfig).length},
  themesWithAppConfig: ${themes.filter(t => t.hasAppConfig).length},
  themesWithDevConfig: ${themes.filter(t => t.hasDevConfig).length},
  themesWithScheduledActions: ${themes.filter(t => t.hasScheduledActions).length},
  themesWithEntities: ${themes.filter(t => t.entities && t.entities.length > 0).length},
  themesWithRoutes: ${themes.filter(t => t.routeFiles && t.routeFiles.length > 0).length},
  themesUsingPlugins: ${themes.filter(t => t.plugins && t.plugins.length > 0).length},
  totalThemeEntities: ${themes.reduce((sum, t) => sum + (t.entities?.length || 0), 0)},
  totalThemeRoutes: ${themes.reduce((sum, t) => sum + (t.routeFiles?.length || 0), 0)},
  generatedAt: '${new Date().toISOString()}',
  themes: [${themes.map(t => `'${t.name}'`).join(', ')}]
}
`
}
