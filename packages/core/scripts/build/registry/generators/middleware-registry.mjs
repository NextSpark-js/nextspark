/**
 * Middleware Registry Generator
 *
 * Generates middleware-registry.ts
 *
 * @module core/scripts/build/registry/generators/middleware-registry
 */

import { join } from 'path'
import { convertCorePath } from '../config.mjs'

/**
 * Generate the middleware registry file
 * @param {Array} middlewares - Discovered middlewares
 * @param {object} config - Configuration object from getConfig()
 * @returns {string} Generated TypeScript content
 */
export function generateMiddlewareRegistry(middlewares, config) {
  const outputFilePath = join(config.outputDir, 'middleware-registry.ts')
  const authImport = convertCorePath('@/core/lib/auth', outputFilePath, config)
  const registryEntries = middlewares.map(middleware => {
    return `  '${middleware.themeName}': {
    themeName: '${middleware.themeName}',
    middleware: ${middleware.middlewareExportName === 'default' ? 'themeMiddleware' : middleware.middlewareExportName},
    middlewarePath: '${middleware.middlewarePath}',
    middlewareExportName: '${middleware.middlewareExportName}',
    exists: ${middleware.exists}
  }`
  }).join(',\n')

  const imports = middlewares.map(middleware => {
    if (middleware.middlewareExportName === 'default') {
      return `import themeMiddleware from '${middleware.middlewarePath}'`
    } else {
      return `import { ${middleware.middlewareExportName} } from '${middleware.middlewarePath}'`
    }
  }).join('\n')

  return `/**
 * Auto-generated Middleware Registry
 *
 * Generated at: ${new Date().toISOString()}
 * Middlewares discovered: ${middlewares.length}
 *
 * DO NOT EDIT - This file is auto-generated by scripts/build-registry.mjs
 *
 * Query functions moved to: @nextsparkjs/core/lib/services/middleware.service
 * Import from there for hasThemeMiddleware, executeThemeMiddleware, etc.
 */

import { NextRequest, NextResponse } from 'next/server'
import type { SessionUser } from '${authImport}'

${imports}

export interface MiddlewareRegistryEntry {
  themeName: string
  middleware: (request: NextRequest, coreSession?: SessionUser | null) => Promise<NextResponse> | NextResponse
  middlewarePath: string
  middlewareExportName: string
  exists: boolean
}

export const MIDDLEWARE_REGISTRY: Record<string, MiddlewareRegistryEntry> = {
${registryEntries}
}

export type ThemeName = ${middlewares.length > 0 ? middlewares.map(m => `'${m.themeName}'`).join(' | ') : 'never'}

/**
 * Middleware registry metadata
 */
export const MIDDLEWARE_METADATA = {
  totalMiddlewares: ${middlewares.length},
  themesWithMiddleware: ${middlewares.filter(m => m.exists).length},
  generatedAt: '${new Date().toISOString()}',
  themes: [${middlewares.map(m => `'${m.themeName}'`).join(', ')}]
}
`
}
